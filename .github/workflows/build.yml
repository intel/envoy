name: Build

on:
  push:
    branches: [ release-*-intel ]
  pull_request:
    branches: [ release-*-intel ]

env:
  HUB: ghcr.io/${{ github.repository }}

jobs:
  build:
    runs-on: self-hosted
    environment:
      name: dev

    env:
      TAG: ${{ github.base_ref || github.ref_name }} 
    steps:
    - uses: actions/checkout@v3.3.0

    - name: Build envoy binary in intel istio-proxy 
      run: |
        ./.github/workflows/build.sh
      env:
        UPDATE_BRANCH: ${{ github.base_ref || github.ref_name }} 

    # - name: Login to the container registry
    #   uses: docker/login-action@v2.1.0
    #   with:
    #     registry: ${{ env.HUB }}
    #     username: ${{ github.repository_owner }}
    #     password: ${{ secrets.GITHUB_TOKEN }}

    # - name: Push image Proxyv2
    #   if: ${{ github.event_name != 'pull_request' }}
    #   run: |
    #     docker push ${HUB}/proxyv2:${TAG}

    - name: Cleanup Image Resources
      if: always()
      continue-on-error: true
      run: |
        docker system prune -a -f && docker volume rm $(docker volume ls -q --filter dangling=true)

    - name: Check disk space at ending
      run: |
        echo "disk space at ending of build:" & df -h
name: Build

on:
  push:
    branches: [ release-*-intel ]
  pull_request:
    branches: [ release-*-intel ]

env:
  HUB: ghcr.io/${{ github.repository }}

jobs:
  build_proxyv2:
    runs-on: ubuntu-20.04

    environment:
      name: dev

    env:
      TAG: ${{ github.base_ref || github.ref_name }}

    steps:
    - uses: actions/checkout@v3

    - name: Build image Proxyv2
      run: |
        ./.github/workflows/build_proxyv2.sh
      env:
        UPDATE_BRANCH: ${{ github.base_ref || github.ref_name }}

    - name: Login to the container registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.HUB }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push image Proxyv2
      if: ${{ github.event_name != 'pull_request' }}
      run: |
        docker push ${HUB}/proxyv2:${TAG}

  build_envoy-contrib:
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v3

    - name: Enable IPv6
      run: |
        sudo mkdir -p /etc/docker
        echo '{
          "ipv6": true,
          "fixed-cidr-v6": "2001:db8:1::/64"
        }' | sudo tee /etc/docker/daemon.json
        sudo service docker restart

    - name: Build envoy-contrib
      run: |
        ./ci/run_envoy_docker.sh './ci/do_ci.sh bazel.release'

    - name: Dockerize
      run: |
        sed -i 's/ENVOY_BINARY=envoy/ENVOY_BINARY=envoy-contrib/' ./ci/Dockerfile-envoy
        sed -i 's/ENVOY_BINARY_SUFFIX=_stripped/ENVOY_BINARY_SUFFIX/' ci/Dockerfile-envoy
        docker build -f ./ci/Dockerfile-envoy -t envoy-contrib:${TAG} .

    - name: Login to the container registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.HUB }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push image envoy-contrib
      if: ${{ github.event_name != 'pull_request' }}
      run: |
        docker push ${HUB}/envoy-contrib:${TAG}
